##############################################################################################################
module AgentXmpp
  
  ############################################################################################################
  class NotConnected < Exception; end

  ############################################################################################################
  class Connection < EventMachine::Connection

    #---------------------------------------------------------------------------------------------------------
    include Parser
    #---------------------------------------------------------------------------------------------------------

    #---------------------------------------------------------------------------------------------------------
    attr_accessor :host, :port
    attr_reader :stream_features, :stream_mechanisms
    #---------------------------------------------------------------------------------------------------------

    #---------------------------------------------------------------------------------------------------------
    # EventMachine::Connection callbacks
    #.........................................................................................................
    def connection_completed
      puts 'connection_completed'
      self.init(self.host)
    end

    #.........................................................................................................
    def receive_data(data)
      puts "receive_data: #{data.to_s}"
      super(data)
    end

    #.........................................................................................................
    def send(data, &blk)
      self.send_data(data.to_s)
    end

    #---------------------------------------------------------------------------------------------------------
    protected
    #---------------------------------------------------------------------------------------------------------
  
    #.........................................................................................................
    def init(to)
      self.send("<?xml version='1.0' ?>") unless @started
      @started = false  
      self.send("<stream:stream xmlns='jabber:client' xmlns:stream='http://etherx.jabber.org/streams' version='1.0' to='#{to}'>" )
    end

  ############################################################################################################
  # Connection
  end

##############################################################################################################
# AgentXmpp
end
